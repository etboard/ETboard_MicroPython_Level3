# ******************************************************************************************
# FileName     : 01._o2_sensor.py
# Description  : 산소 농도를 쉘에 표시하기
# Author       : 박은정
# Created Date : 2025.08.07
# Modified     : 
# ******************************************************************************************


import time
from machine import ADC, Pin
from ETboard.lib.pin_define import *                     # ETboard 핀 관련 모


#===========================================================================================
# 산소 센서 사용하기
#===========================================================================================
o2_sensor = ADC(Pin(A4))                                 # D6 핀에 센서 연결
VREF = 3.3                                               # 기준 전압
ADC_RESOLUTION = 4095                                    # 12비트 ADC 최대값


#===========================================================================================
# 전역 변수
#===========================================================================================
o2 = 0
previous_time = 0


#===========================================================================================
def setup():                                             # 응용 프로그램 설정하기
#===========================================================================================
    global sound_timer
    o2_sensor.atten(ADC.ATTN_11DB)                       # 가변저항 입력 모드 설정
    o2_sensor.width(ADC.WIDTH_12BIT)                     # 해상도 0~4095


#===========================================================================================
def loop():                                              # 응용 프로그램 루프
#===========================================================================================
    do_sensing_proces()                                  # 센싱 처리
    et_short_periodic_process()


#===========================================================================================
def do_sensing_proces():                                 # 센싱 처리
#===========================================================================================
    o2_sensor_update()


#===========================================================================================
def o2_sensor_update():                                  # 산소 센서 값 업데이트
#===========================================================================================
    global o2

    raw = o2_sensor.read()
    voltage = raw / ADC_RESOLUTION * VREF
    o2 = voltage * 0.21 / 2.0 * 100

    time.sleep(1)
    

#===========================================================================================
def et_short_periodic_process():                         # 짧은 주기 처리                    
#===========================================================================================
    global previous_time

    interval = 1                                         # 1초마다 정보 표시
    now = int(round(time.time()))

    if now - previous_time < interval:                   # 1초가 지나지 않았다면
        return

    previous_time = now
    display_information()
    

#===========================================================================================
def display_information():                               # oled 표시
#===========================================================================================
    global o2
    string_o2 = "{:.2f}".format(o2 - 3)

    print('O2: ' + string_o2 + '%')                      # 쉘에 출력


#===========================================================================================
# 시작 지점                     
#===========================================================================================
if __name__ == '__main__':
    setup()
    while True:
        loop()


#===========================================================================================
#                                                    
# (주)한국공학기술연구원 http://et.ketri.re.kr       
#
#=========================================================================================== 
