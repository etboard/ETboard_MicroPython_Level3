# ******************************************************************************************
# FileName     : 02._dust_oled.py
# Description  : 미세먼지 농도를 OLED에 표시하기
# Author       : 박은정
# Created Date : 2025.08.07
# Modified     : 
# ******************************************************************************************


import time
from machine import Pin
from ETboard.lib.pin_define import *              # ETboard 핀 관련 모듈


#===========================================================================================
# 미세먼지 센서 사용하기
#===========================================================================================
from ET_PPD42NS import ET_PPD42NS                        # 미세먼지 센서
dust_sensor = ET_PPD42NS(A3)                             # A3 핀에 센서 연결


#===========================================================================================
# OLED 표시 장치 사용하기
#===========================================================================================
from ETboard.lib.OLED_U8G2 import *
oled = oled_u8g2()


#===========================================================================================
# 전역변수
#===========================================================================================
previous_time = 0


#===========================================================================================
def setup():                                             # 응용 프로그램 설정하기
#===========================================================================================
    dust_sensor.begin()


#===========================================================================================
def loop():                                              # 응용 프로그램 루프
#===========================================================================================
    do_sensing_process()
    et_short_periodic_process()


#===========================================================================================
def do_sensing_process():                                # 센싱 처리
#===========================================================================================
    dust_sensor.update()


#===========================================================================================
def et_short_periodic_process():                         # 짧은 주기 처리                    
#===========================================================================================
    global previous_time

    interval = 1                                         # 1초마다 정보 표시
    now = int(round(time.time()))

    if now - previous_time < interval:                   # 1초가 지나지 않았다면
        return

    previous_time = now

    display_information()
    

#===========================================================================================
def display_information():                               # 정보 표시               
#===========================================================================================
    string_dust = "{:.6f}".format(dust_sensor.get_ugm3());

    oled.clear()
    oled.setLine(2, 'dust: ' + string_dust + 'ppm')      # OLED 모듈 2번 줄에 저장

    oled.display()                                       # 저장된 내용을 oled에 보여줌  


#===========================================================================================
# 시작 지점
#===========================================================================================
if __name__ == "__main__":
    setup()
    while True:
        loop()


# ==========================================================================================
#
#  (주)한국공학기술연구원 http://et.ketri.re.kr
#
# ==========================================================================================
